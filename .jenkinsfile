pipeline {
    agent {
        docker {
            image 'docker:24-dind'
            args '--privileged -v /var/run/docker.sock:/var/run/docker.sock -u root'
        }
    }
    
    parameters {
        choice(
            name: 'DEPLOY_ENVIRONMENT',
            choices: ['production', 'test'],
            description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        )
    }
    
    environment {
        // Docker Registryé…ç½®
        DOCKER_REGISTRY = 'crpi-nessk20nyrqkpfxu.cn-shenzhen.personal.cr.aliyuncs.com'
        DOCKER_REPO = 'giihg/nexus-backend'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        
        // Dockeré…ç½®
        DOCKER_TLS_CERTDIR = ''
        DOCKER_HOST = 'unix:///var/run/docker.sock'
        DOCKER_CONFIG = '/tmp/.docker'
        
        // å‡­æ®IDé…ç½®
        DOCKER_CREDENTIALS_ID = '812fd0fe-1459-4581-a123-a47a5a90424e'
        GIT_CREDENTIALS_ID = 'da36b5e6-be3d-4b3f-a5a4-6be2483dbaed'
        SSH_CREDENTIALS_ID = '49328086-fb58-421f-8f1e-749f7d5d528d'
        
        // è¿œç¨‹éƒ¨ç½²é…ç½® - æ ¹æ®ç¯å¢ƒåŠ¨æ€è®¾ç½®
        DEPLOY_SERVER_HOST = "${params.DEPLOY_ENVIRONMENT == 'test' ? '172.16.212.14' : '172.16.212.10'}"
        DEPLOY_SERVER_USER = 'user'
        DEPLOY_REPO_URL = 'https://e.coding.net/g-iwsh7192/Agent/nexus-backend.git'
        DEPLOY_SCRIPT_PATH = 'scripts/deploy.sh'
        ENV_FILE_CREDENTIALS_ID = "${params.DEPLOY_ENVIRONMENT == 'test' ? '9a75079c-9652-40b4-8351-11333813469b' : '8936d228-c3ce-4522-97d9-f5d69d4ac7a6'}"
        
        // æ„å»ºé…ç½®
        PYTHON_VERSION = '3.11'
        NODE_ENV = "${params.DEPLOY_ENVIRONMENT == 'test' ? 'test' : 'production'}"
    }
    
    options {
        // æ„å»ºä¿ç•™ç­–ç•¥
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // è¶…æ—¶è®¾ç½®
        timeout(time: 30, unit: 'MINUTES')
        // ç¦ç”¨å¹¶å‘æ„å»º
        disableConcurrentBuilds()
    }
    
    stages {
        stage('åˆå§‹åŒ–ç¯å¢ƒ') {
            steps {
                script {
                    echo "ğŸ”§ åˆå§‹åŒ–Dockerå’ŒGitç¯å¢ƒ..."
                    sh '''
                        # åˆ›å»ºDockeré…ç½®ç›®å½•
                        mkdir -p /tmp/.docker
                        chmod 755 /tmp/.docker
                        
                        # éªŒè¯Dockeræ˜¯å¦æ­£å¸¸å·¥ä½œ
                        docker --version
                        docker info
                        
                        # æ£€æŸ¥Docker socketæƒé™
                        ls -la /var/run/docker.sock
                        
                        # ä¿®å¤Gitå®‰å…¨é…ç½®é—®é¢˜
                        echo "é…ç½®Gitå®‰å…¨ç›®å½•..."
                        git config --global --add safe.directory '*'
                        
                        # æˆ–è€…æ›´å®‰å…¨çš„æ–¹å¼ï¼Œåªæ·»åŠ å½“å‰å·¥ä½œç›®å½•
                        # git config --global --add safe.directory "${WORKSPACE}"
                        
                        # éªŒè¯Gité…ç½®
                        echo "éªŒè¯Gité…ç½®..."
                        git config --global --list | grep safe.directory || echo "æœªè®¾ç½®safe.directory"
                    '''
                }
            }
        }
        
        stage('æ‹‰å–ä»£ç ') {
            steps {
                script {
                    checkout([$class: 'GitSCM', 
                        branches: [[name: '*/master']], 
                        userRemoteConfigs: [[
                            url: 'https://e.coding.net/g-iwsh7192/Agent/nexus-backend.git',
                            credentialsId: env.GIT_CREDENTIALS_ID
                        ]]
                    ])
                    
                    // åœ¨æ‹‰å–ä»£ç åå†æ¬¡ç¡®ä¿Gité…ç½®æ­£ç¡®
                    sh '''
                        echo "è®¾ç½®å½“å‰ä»“åº“ä¸ºå®‰å…¨ç›®å½•..."
                        git config --global --add safe.directory "$(pwd)"
                        
                        # éªŒè¯GitçŠ¶æ€
                        echo "éªŒè¯Gitä»“åº“çŠ¶æ€..."
                        git status
                        git log -1 --oneline
                    '''
                }
            }
        }
        
        stage('æ„å»ºDockeré•œåƒ') {
            steps {
                script {
                    echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
                    
                    // æ£€æŸ¥Dockerfile
                    sh '''
                        if [ ! -f Dockerfile ]; then
                            echo "âŒ æœªæ‰¾åˆ°Dockerfile"
                            exit 1
                        fi
                        
                        echo "=== Dockerfileå†…å®¹é¢„è§ˆ ==="
                        head -20 Dockerfile
                    '''
                    
                    // æ„å»ºé•œåƒ
                    sh '''
                        echo "æ„å»ºé•œåƒ: ${DOCKER_REGISTRY}/${DOCKER_REPO}:${IMAGE_TAG}"
                        
                        # è®¾ç½®Dockeré…ç½®ç›®å½•
                        export DOCKER_CONFIG=/tmp/.docker
                        
                        # è·å–Gitä¿¡æ¯ï¼ˆå¢åŠ é”™è¯¯å¤„ç†ï¼‰
                        VCS_REF="unknown"
                        if git rev-parse --short HEAD >/dev/null 2>&1; then
                            VCS_REF=$(git rev-parse --short HEAD)
                            echo "Gitæäº¤ID: $VCS_REF"
                        else
                            echo "æ— æ³•è·å–Gitæäº¤IDï¼Œä½¿ç”¨é»˜è®¤å€¼: $VCS_REF"
                        fi
                        
                        docker build \
                            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                            --build-arg VCS_REF=$VCS_REF \
                            --build-arg BUILD_NUMBER=${BUILD_NUMBER} \
                            -t ${DOCKER_REGISTRY}/${DOCKER_REPO}:${IMAGE_TAG} \
                            .
                        
                        # æ ‡è®°latestæ ‡ç­¾
                        docker tag ${DOCKER_REGISTRY}/${DOCKER_REPO}:${IMAGE_TAG} ${DOCKER_REGISTRY}/${DOCKER_REPO}:latest
                        
                        # æ˜¾ç¤ºé•œåƒä¿¡æ¯
                        echo "=== æ„å»ºçš„é•œåƒåˆ—è¡¨ ==="
                        docker images | grep ${DOCKER_REPO}
                        
                        # æ˜¾ç¤ºé•œåƒå¤§å°ï¼ˆä½¿ç”¨æ›´ç®€å•çš„æ–¹æ³•ï¼‰
                        echo "=== é•œåƒå¤§å°ä¿¡æ¯ ==="
                        IMAGE_SIZE=$(docker inspect ${DOCKER_REGISTRY}/${DOCKER_REPO}:${IMAGE_TAG} --format='{{.Size}}')
                        echo "é•œåƒå¤§å°: $IMAGE_SIZE å­—èŠ‚"
                        
                        # è®¡ç®—MBå¤§å°
                        IMAGE_SIZE_MB=$((IMAGE_SIZE / 1024 / 1024))
                        echo "é•œåƒå¤§å°: ${IMAGE_SIZE_MB}MB"
                    '''
                }
            }
        }
        
        stage('æ¨é€Dockeré•œåƒ') {
            steps {
                script {
                    echo "ğŸ“¤ æ¨é€Dockeré•œåƒåˆ°Registry..."
                    
                    // è·å–å½“å‰åˆ†æ”¯åç§° - æ”¹è¿›çš„æ–¹æ³•ï¼Œå¢åŠ æ›´å¤šå®¹é”™å¤„ç†
                    def branchName = ""
                    try {
                        // æ–¹æ³•1: å°è¯•ä½¿ç”¨Jenkinsç¯å¢ƒå˜é‡
                        if (env.BRANCH_NAME) {
                            branchName = env.BRANCH_NAME
                            echo "ä½¿ç”¨ BRANCH_NAME: ${branchName}"
                        } else if (env.GIT_BRANCH) {
                            branchName = env.GIT_BRANCH
                            echo "ä½¿ç”¨ GIT_BRANCH: ${branchName}"
                        } else {
                            // æ–¹æ³•2: ä½¿ç”¨gitå‘½ä»¤è·å–åˆ†æ”¯å - å¢åŠ æ›´å¤šå®¹é”™å¤„ç†
                            def gitBranchResult = sh(
                                script: '''
                                    # ç¡®ä¿Gité…ç½®æ­£ç¡®
                                    git config --global --add safe.directory "$(pwd)" || true
                                    
                                    # å°è¯•å¤šç§æ–¹æ³•è·å–åˆ†æ”¯å
                                    if git rev-parse --abbrev-ref HEAD 2>/dev/null; then
                                        exit 0
                                    elif git branch --show-current 2>/dev/null; then
                                        exit 0
                                    elif git symbolic-ref --short HEAD 2>/dev/null; then
                                        exit 0
                                    else
                                        echo "master"  # é»˜è®¤åˆ†æ”¯
                                        exit 0
                                    fi
                                ''', 
                                returnStdout: true
                            ).trim()
                            
                            branchName = gitBranchResult
                            echo "ä½¿ç”¨ git å‘½ä»¤è·å–åˆ†æ”¯: ${branchName}"
                        }
                        
                        // æ¸…ç†åˆ†æ”¯åç§°ï¼ˆç§»é™¤origin/å‰ç¼€ï¼‰
                        if (branchName && branchName.startsWith('origin/')) {
                            branchName = branchName.replace('origin/', '')
                            echo "æ¸…ç†åçš„åˆ†æ”¯å: ${branchName}"
                        }
                        
                        // å¦‚æœåˆ†æ”¯åä¸ºç©ºæˆ–æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼
                        if (!branchName || branchName.trim().isEmpty()) {
                            branchName = "master"
                            echo "ä½¿ç”¨é»˜è®¤åˆ†æ”¯å: ${branchName}"
                        }
                        
                    } catch (Exception e) {
                        echo "è·å–åˆ†æ”¯åå¤±è´¥: ${e.getMessage()}"
                        branchName = "master"  // ä½¿ç”¨é»˜è®¤åˆ†æ”¯å
                        echo "ä½¿ç”¨é»˜è®¤åˆ†æ”¯å: ${branchName}"
                    }
                    
                    echo "ğŸŒ¿ å½“å‰åˆ†æ”¯: ${branchName}"
                    
                    // åˆ¤æ–­æ˜¯å¦ä¸ºä¸»åˆ†æ”¯
                    def isMainBranch = (branchName == "main" || branchName == "master")
                    echo "æ˜¯å¦ä¸ºä¸»åˆ†æ”¯: ${isMainBranch}"
                    
                    withCredentials([
                        usernamePassword(
                            credentialsId: env.DOCKER_CREDENTIALS_ID,
                            usernameVariable: 'DOCKER_USERNAME',
                            passwordVariable: 'DOCKER_PASSWORD'
                        )
                    ]) {
                        sh '''
                            # è®¾ç½®Dockeré…ç½®ç›®å½•
                            export DOCKER_CONFIG=/tmp/.docker
                            
                            # ç™»å½•Docker Registry
                            echo "ç™»å½•åˆ° ${DOCKER_REGISTRY}..."
                            echo $DOCKER_PASSWORD | docker login ${DOCKER_REGISTRY} -u $DOCKER_USERNAME --password-stdin
                            
                            # æ¨é€å¸¦ç‰ˆæœ¬å·çš„é•œåƒ
                            echo "æ¨é€é•œåƒ: ${DOCKER_REGISTRY}/${DOCKER_REPO}:${IMAGE_TAG}"
                            docker push ${DOCKER_REGISTRY}/${DOCKER_REPO}:${IMAGE_TAG}
                            
                            echo "âœ… é•œåƒæ¨é€å®Œæˆ"
                        '''
                        
                        sh '''
                            echo "æ¨é€é•œåƒ: ${DOCKER_REGISTRY}/${DOCKER_REPO}:latest"
                            docker push ${DOCKER_REGISTRY}/${DOCKER_REPO}:latest
                            echo "âœ… latestæ ‡ç­¾æ¨é€å®Œæˆ"
                        '''
                    }
                }
            }
        }
        
        stage('è¿œç¨‹éƒ¨ç½²') {
            steps {
                script {
                    echo "ğŸš€ å¼€å§‹è¿œç¨‹éƒ¨ç½²åˆ° ${params.DEPLOY_ENVIRONMENT} ç¯å¢ƒ..."
                    echo "ğŸ¯ ç›®æ ‡æœåŠ¡å™¨: ${DEPLOY_SERVER_HOST}"
                    
                    withCredentials([
                        sshUserPrivateKey(
                            credentialsId: env.SSH_CREDENTIALS_ID,
                            keyFileVariable: 'SSH_KEY',
                            usernameVariable: 'SSH_USER'
                        )
                    ]) {
                        sh '''
                            # è®¾ç½®SSHé…ç½®
                            mkdir -p ~/.ssh
                            chmod 700 ~/.ssh
                            
                            # é…ç½®SSHä»¥ä½¿ç”¨æä¾›çš„ç§é’¥
                            eval $(ssh-agent -s)
                            ssh-add ${SSH_KEY}
                            
                            # è®¾ç½®ç›®æ ‡æœåŠ¡å™¨ä¿¡æ¯
                            TARGET_HOST="${DEPLOY_SERVER_HOST}"
                            TARGET_USER="${DEPLOY_SERVER_USER}"
                            TARGET_PATH="/home/${DEPLOY_SERVER_USER}/nexus-backend"
                            
                            echo "ğŸ” è¿æ¥ä¿¡æ¯:"
                            echo "  æœåŠ¡å™¨: ${TARGET_HOST}"
                            echo "  ç”¨æˆ·: ${TARGET_USER}"
                            echo "  è·¯å¾„: ${TARGET_PATH}"
                            
                            # æµ‹è¯•SSHè¿æ¥
                            echo "ğŸ”— æµ‹è¯•SSHè¿æ¥..."
                            ssh -o StrictHostKeyChecking=no ${TARGET_USER}@${TARGET_HOST} "echo 'SSHè¿æ¥æˆåŠŸ'"
                            
                            # åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šåˆ›å»ºé¡¹ç›®ç›®å½•å¹¶è®¾ç½®æƒé™
                            echo "ğŸ“ åˆ›å»ºé¡¹ç›®ç›®å½•å¹¶è®¾ç½®æƒé™..."
                            ssh -o StrictHostKeyChecking=no ${TARGET_USER}@${TARGET_HOST} "
                                mkdir -p ${TARGET_PATH} && \
                                chmod 755 ${TARGET_PATH} && \
                                chown ${TARGET_USER}:${TARGET_USER} ${TARGET_PATH}
                            "
                            
                            # ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨Jenkinså‡­æ®æ‹·è´envæ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨
                            echo "ğŸ“¤ ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨Jenkinså‡­æ®æ‹·è´envæ–‡ä»¶åˆ°~/nexus-backend/.env..."
                        '''
                        
                        // ä½¿ç”¨Jenkinså‡­æ®ç³»ç»Ÿè·å–ç¯å¢ƒæ–‡ä»¶
                        withCredentials([
                            file(
                                credentialsId: env.ENV_FILE_CREDENTIALS_ID,
                                variable: 'ENV_FILE_PATH'
                            ),
                            sshUserPrivateKey(
                            credentialsId: env.SSH_CREDENTIALS_ID,
                            keyFileVariable: 'SSH_KEY',
                            usernameVariable: 'SSH_USER'
                        )
                        ]) {
                            sh '''
                                # é‡æ–°è®¾ç½®ç›®æ ‡æœåŠ¡å™¨ä¿¡æ¯ï¼ˆåœ¨withCredentialså—å†…ï¼‰
                                TARGET_HOST="${DEPLOY_SERVER_HOST}"
                                TARGET_USER="${DEPLOY_SERVER_USER}"
                                TARGET_PATH="/home/${DEPLOY_SERVER_USER}/nexus-backend"
                                
                                # æ£€æŸ¥å‡­æ®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                                if [ -f "${ENV_FILE_PATH}" ]; then
                                    echo "âœ… æ‰¾åˆ°Jenkinså‡­æ®ä¸­çš„ç¯å¢ƒæ–‡ä»¶"
                                    scp -o StrictHostKeyChecking=no -i  ${SSH_KEY} ${ENV_FILE_PATH} ${TARGET_USER}@${TARGET_HOST}:${TARGET_PATH}/.env
                                    echo "âœ… ç¯å¢ƒæ–‡ä»¶å·²ä»Jenkinså‡­æ®æ‹·è´åˆ° ${TARGET_PATH}/.env"
                                else
                                    echo "âš ï¸ Jenkinså‡­æ®ä¸­æœªæ‰¾åˆ°ç¯å¢ƒæ–‡ä»¶ï¼Œå°è¯•ä½¿ç”¨æœ¬åœ°æ–‡ä»¶..."
                                    # å›é€€åˆ°ä½¿ç”¨æœ¬åœ°.envæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                                    if [ -f ".env" ]; then
                                        echo "ğŸ“ æ‰¾åˆ°æœ¬åœ°.envæ–‡ä»¶ï¼Œæ­£åœ¨æ‹·è´..."
                                        scp -o StrictHostKeyChecking=no .env ${TARGET_USER}@${TARGET_HOST}:${TARGET_PATH}/.env
                                        echo "âœ… æœ¬åœ°.envæ–‡ä»¶å·²æ‹·è´åˆ° ${TARGET_PATH}/.env"
                                    elif [ -f ".env.example" ]; then
                                        echo "ğŸ“ ä½¿ç”¨.env.exampleä½œä¸ºæ¨¡æ¿..."
                                        scp -o StrictHostKeyChecking=no .env.example ${TARGET_USER}@${TARGET_HOST}:${TARGET_PATH}/.env
                                        echo "âœ… .env.exampleå·²æ‹·è´åˆ° ${TARGET_PATH}/.env"
                                    else
                                        echo "âŒ æœªæ‰¾åˆ°ä»»ä½•ç¯å¢ƒæ–‡ä»¶ï¼Œéƒ¨ç½²å¯èƒ½å¤±è´¥"
                                        exit 1
                                    fi
                                fi
                            '''
                        }
                        
                        sh '''
                            # é‡æ–°è®¾ç½®ç›®æ ‡æœåŠ¡å™¨ä¿¡æ¯ï¼ˆåœ¨æ–°çš„shå—ä¸­ï¼‰
                            TARGET_HOST="${DEPLOY_SERVER_HOST}"
                            TARGET_USER="${DEPLOY_SERVER_USER}"
                            TARGET_PATH="/home/${DEPLOY_SERVER_USER}/nexus-backend"
                            
                            # ç¡®ä¿æ‹·è´çš„æ–‡ä»¶æœ‰æ­£ç¡®çš„æƒé™
                            echo "ğŸ”§ è®¾ç½®æ–‡ä»¶æƒé™..."
                            ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} ${TARGET_USER}@${TARGET_HOST} "
                                if [ -f ${TARGET_PATH}/.env ]; then
                                    chmod 644 ${TARGET_PATH}/.env && \
                                    chown ${TARGET_USER}:${TARGET_USER} ${TARGET_PATH}/.env
                                    echo 'âœ… .envæ–‡ä»¶æƒé™è®¾ç½®å®Œæˆ'
                                fi
                            "
                            
                            # ç¬¬äºŒæ­¥ï¼šæ‹·è´scripts/deploy.shåˆ°ç›®æ ‡æœåŠ¡å™¨çš„~/nexus-backend/deploy.shå¹¶æ‰§è¡Œ
                            echo "ğŸ“¤ ç¬¬äºŒæ­¥ï¼šæ‹·è´scripts/deploy.shåˆ°~/nexus-backend/deploy.sh..."
                            scp -o StrictHostKeyChecking=no -i ${SSH_KEY} scripts/deploy.sh ${TARGET_USER}@${TARGET_HOST}:${TARGET_PATH}/deploy.sh
                            echo "âœ… scripts/deploy.shå·²æ‹·è´åˆ° ${TARGET_PATH}/deploy.sh"
                            
                            # è®¾ç½®deploy.shè„šæœ¬æƒé™
                            echo "ğŸ”§ è®¾ç½®deploy.shè„šæœ¬æƒé™..."
                            ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} ${TARGET_USER}@${TARGET_HOST} "
                                chmod +x ${TARGET_PATH}/deploy.sh && \
                                chown ${TARGET_USER}:${TARGET_USER} ${TARGET_PATH}/deploy.sh
                                echo 'âœ… deploy.shè„šæœ¬æƒé™è®¾ç½®å®Œæˆ'
                            "
                            
                            # ç¬¬ä¸‰æ­¥ï¼šåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè¿›è¡ŒDockerç™»å½•
                            echo "ğŸ” ç¬¬ä¸‰æ­¥ï¼šåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè¿›è¡ŒDockerç™»å½•..."
                        '''
                        
                        // ä½¿ç”¨Dockerå‡­æ®åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šç™»å½•
                        withCredentials([
                            usernamePassword(
                                credentialsId: env.DOCKER_CREDENTIALS_ID,
                                usernameVariable: 'DOCKER_USERNAME',
                                passwordVariable: 'DOCKER_PASSWORD'
                            )
                        ]) {
                            sh '''
                                # é‡æ–°è®¾ç½®ç›®æ ‡æœåŠ¡å™¨ä¿¡æ¯ï¼ˆåœ¨æ–°çš„shå—ä¸­ï¼‰
                                TARGET_HOST="${DEPLOY_SERVER_HOST}"
                                TARGET_USER="${DEPLOY_SERVER_USER}"
                                TARGET_PATH="/home/${DEPLOY_SERVER_USER}/nexus-backend"
                                
                                # åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡ŒDockerç™»å½•
                                ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} ${TARGET_USER}@${TARGET_HOST} "
                                    echo 'ğŸ” ç™»å½•åˆ°Docker Registry...'
                                    echo '${DOCKER_PASSWORD}' | docker login ${DOCKER_REGISTRY} -u '${DOCKER_USERNAME}' --password-stdin
                                    echo 'âœ… Dockerç™»å½•æˆåŠŸ'
                                "
                            '''
                        }
                        
                        sh '''
                            # é‡æ–°è®¾ç½®ç›®æ ‡æœåŠ¡å™¨ä¿¡æ¯ï¼ˆåœ¨æ–°çš„shå—ä¸­ï¼‰
                            TARGET_HOST="${DEPLOY_SERVER_HOST}"
                            TARGET_USER="${DEPLOY_SERVER_USER}"
                            TARGET_PATH="/home/${DEPLOY_SERVER_USER}/nexus-backend"
                            
                            # ç¬¬å››æ­¥ï¼šæ‰§è¡Œéƒ¨ç½²è„šæœ¬
                            echo "ğŸš€ ç¬¬å››æ­¥ï¼šæ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
                            ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} ${TARGET_USER}@${TARGET_HOST} "
                                cd ${TARGET_PATH} && \
                                ./deploy.sh
                            "
                            
                            echo "âœ… è¿œç¨‹éƒ¨ç½²å®Œæˆï¼"
                        '''
                    }
                }
            }
        }
        
        stage('éƒ¨ç½²é€šçŸ¥') {
            steps {
                script {
                    echo "ğŸ“¢ å‘é€éƒ¨ç½²é€šçŸ¥..."
                    
                    // å®‰å…¨åœ°è·å–Gitæäº¤ä¿¡æ¯
                    def gitCommit = "unknown"
                    try {
                        gitCommit = sh(
                            script: '''
                                git config --global --add safe.directory "$(pwd)" || true
                                git rev-parse --short HEAD 2>/dev/null || echo "unknown"
                            ''', 
                            returnStdout: true
                        ).trim()
                    } catch (Exception e) {
                        echo "è·å–Gitæäº¤ä¿¡æ¯å¤±è´¥: ${e.getMessage()}"
                        gitCommit = "unknown"
                    }
                    
                    def deployInfo = """
                    ğŸš€ **éƒ¨ç½²ä¿¡æ¯**
                    - é¡¹ç›®: nexus-backend
                    - ç¯å¢ƒ: ${params.DEPLOY_ENVIRONMENT}
                    - æœåŠ¡å™¨: ${DEPLOY_SERVER_HOST}
                    - åˆ†æ”¯: ${env.BRANCH_NAME ?: 'unknown'}
                    - æ„å»ºå·: ${env.BUILD_NUMBER}
                    - é•œåƒ: ${DOCKER_REGISTRY}/${DOCKER_REPO}:${IMAGE_TAG}
                    - æäº¤: ${gitCommit}
                    - æ—¶é—´: ${new Date().format('yyyy-MM-dd HH:mm:ss')}
                    """
                    
                    echo deployInfo
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "ğŸ§¹ æ‰§è¡Œæ¸…ç†æ“ä½œ..."
                try {
                    // è®¾ç½®Dockeré…ç½®ç›®å½•
                    sh 'export DOCKER_CONFIG=/tmp/.docker'
                    
                    // ç™»å‡ºDocker Registry
                    sh "docker logout ${DOCKER_REGISTRY} || true"
                    
                    // æ¸…ç†æœ¬åœ°é•œåƒ
                    sh "docker rmi ${DOCKER_REGISTRY}/${DOCKER_REPO}:${IMAGE_TAG} || true"
                    sh "docker rmi ${DOCKER_REGISTRY}/${DOCKER_REPO}:latest || true"
                    
                    // æ¸…ç†Dockerç³»ç»Ÿ
                    sh "docker system prune -f || true"
                    
                    // æ¸…ç†æ„å»ºç¼“å­˜
                    sh "docker builder prune -f || true"
                    
                    // æ¸…ç†ä¸´æ—¶Dockeré…ç½®ç›®å½•
                    sh "rm -rf /tmp/.docker || true"
                    
                } catch (Exception e) {
                    echo "âš ï¸ æ¸…ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${e.getMessage()}"
                }
            }
        }
        
        success {
            script {
                // è·å–åˆ†æ”¯åç§°ï¼ˆä¸æ¨é€é˜¶æ®µç›¸åŒçš„é€»è¾‘ï¼‰
                def branchName = ""
                try {
                    if (env.BRANCH_NAME) {
                        branchName = env.BRANCH_NAME
                    } else if (env.GIT_BRANCH) {
                        branchName = env.GIT_BRANCH
                    } else {
                        branchName = sh(
                            script: '''
                                git config --global --add safe.directory "$(pwd)" || true
                                git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "master"
                            ''', 
                            returnStdout: true
                        ).trim()
                    }
                    
                    if (branchName && branchName.startsWith('origin/')) {
                        branchName = branchName.replace('origin/', '')
                    }
                    
                    if (!branchName || branchName.trim().isEmpty()) {
                        branchName = "master"
                    }
                } catch (Exception e) {
                    branchName = "master"
                }
                
                def isMainBranch = (branchName == "main" || branchName == "master")
                
                echo "âœ… ğŸ‰ æµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼"
                echo "ğŸŒ¿ å½“å‰åˆ†æ”¯: ${branchName}"
                echo "ğŸ“¦ é•œåƒå·²æ¨é€: ${DOCKER_REGISTRY}/${DOCKER_REPO}:${IMAGE_TAG}"
                if (isMainBranch) {
                    echo "ğŸ”— latesté•œåƒåœ°å€: ${DOCKER_REGISTRY}/${DOCKER_REPO}:latest"
                }
                echo "â±ï¸ æ„å»ºè€—æ—¶: ${currentBuild.durationString}"
                
                // è®¾ç½®æ„å»ºæè¿°
                currentBuild.description = "âœ… æˆåŠŸæ„å»ºå¹¶æ¨é€é•œåƒ ${IMAGE_TAG} (${branchName})"
            }
        }
        
        failure {
            script {
                echo "âŒ ğŸ’¥ æµæ°´çº¿æ‰§è¡Œå¤±è´¥ï¼"
                echo "ğŸ“‹ è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
                echo "ğŸ” å¤±è´¥é˜¶æ®µ: ${env.STAGE_NAME ?: 'æœªçŸ¥'}"
                
                // è®¾ç½®æ„å»ºæè¿°
                currentBuild.description = "âŒ æ„å»ºå¤±è´¥ - ${env.STAGE_NAME ?: 'æœªçŸ¥é˜¶æ®µ'}"
            }
        }
        
        unstable {
            script {
                echo "âš ï¸ æµæ°´çº¿æ‰§è¡Œä¸ç¨³å®šï¼ˆå¯èƒ½æ˜¯æµ‹è¯•å¤±è´¥æˆ–å®‰å…¨æ‰«æå‘ç°é—®é¢˜ï¼‰"
                currentBuild.description = "âš ï¸ æ„å»ºä¸ç¨³å®š - è¯·æ£€æŸ¥æµ‹è¯•å’Œæ‰«æç»“æœ"
            }
        }
        
        aborted {
            script {
                echo "ğŸ›‘ æµæ°´çº¿æ‰§è¡Œè¢«ä¸­æ­¢"
                currentBuild.description = "ğŸ›‘ æ„å»ºè¢«ä¸­æ­¢"
            }
        }
    }
}